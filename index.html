<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"], input[type="file"] {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            width: 100%;
            margin-top: 0.5rem;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #2563eb;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #1e40af;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
    </style>
</head>
<body class="p-8">

    <div id="messageBox" class="modal">
        <div class="modal-content">
            <p id="messageText" class="text-lg font-medium mb-4"></p>
            <button onclick="hideMessage()" class="btn btn-primary">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="container space-y-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†</h1>
            <div id="authStatus" class="flex items-center space-x-4">
                <span id="userName" class="text-gray-600"></span>
                <button id="authButton" class="btn btn-primary">Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
            </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã®æ¤œç´¢ -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œç´¢</h2>
            <div class="flex items-end space-x-4">
                <div class="w-full">
                    <label for="searchQuery" class="block text-sm font-medium text-gray-700">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="text" id="searchQuery" placeholder="ä¾‹: ãƒ¬ãƒãƒ¼ãƒˆ.pdf" class="mt-1 block w-full rounded-md shadow-sm">
                </div>
                <button onclick="searchFilesAndFolders()" class="btn btn-primary whitespace-nowrap">æ¤œç´¢</button>
            </div>
            <div id="searchResults" class="mt-4 space-y-2 text-sm"></div>
        </div>
        
        <div class="grid md:grid-cols-2 gap-6">
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="space-y-4">
                    <div>
                        <label for="uploadFile" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                        <input type="file" id="uploadFile" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                    </div>
                    <div>
                        <label for="uploadFileName" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                        <input type="text" id="uploadFileName" placeholder="æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«å" class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="uploadFile()" class="btn btn-primary w-full">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="space-y-4">
                    <div>
                        <label for="downloadFileUrl" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URL</label>
                        <input type="text" id="downloadFileUrl" placeholder="ä¾‹: https://drive.google.com/file/d/..." class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="downloadFile()" class="btn btn-primary w-full">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã®å…±æœ‰ -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã‚’å…±æœ‰</h2>
                <div class="space-y-4">
                    <div>
                        <label for="shareUrl" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URL</label>
                        <input type="text" id="shareUrl" placeholder="ä¾‹: https://drive.google.com/drive/folders/..." class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="shareEmail" class="block text-sm font-medium text-gray-700">å…±æœ‰ç›¸æ‰‹ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="text" id="shareEmail" placeholder="ä¾‹: user@example.com" class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="shareFile()" class="btn btn-primary w-full">å…±æœ‰</button>
                </div>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã®å…±æœ‰åœæ­¢ -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã‚’å…±æœ‰åœæ­¢</h2>
                <div class="space-y-4">
                    <div>
                        <label for="unshareUrl" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URL</label>
                        <input type="text" id="unshareUrl" placeholder="ä¾‹: https://drive.google.com/file/d/..." class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="unshareFile()" class="btn btn-primary w-full">å…±æœ‰åœæ­¢</button>
                </div>
            </div>

            <!-- ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆ/å‰Šé™¤ -->
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ</h2>
                <div class="space-y-4">
                    <div>
                        <label for="createFolderName" class="block text-sm font-medium text-gray-700">æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€å</label>
                        <input type="text" id="createFolderName" placeholder="ä¾‹: æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="createFolder()" class="btn btn-primary w-full">ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</button>
                </div>
            </div>

            <div class="card">
                <h2 class="text-2xl font-semibold mb-4">ãƒ•ã‚©ãƒ«ãƒ€/ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤</h2>
                <div class="space-y-4">
                    <div>
                        <label for="deleteUrl" class="block text-sm font-medium text-gray-700">ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URL</label>
                        <input type="text" id="deleteUrl" placeholder="ä¾‹: https://drive.google.com/drive/folders/..." class="mt-1 block w-full rounded-md shadow-sm">
                    </div>
                    <button onclick="deleteFileOrFolder()" class="btn btn-primary w-full">å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ« ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ç›£è¦– -->
        <div class="card">
            <h2 class="text-2xl font-semibold mb-4">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
            <p class="text-gray-500 mb-2">ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆãªã©ã®æ“ä½œã‚’è¡Œã†ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <div id="activityLog" class="space-y-2 text-sm max-h-96 overflow-y-auto">
                <p class="text-gray-500">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...</p>
            </div>
        </div>
    </div>

    <!-- Google API Client Library -->
    <script async defer src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        const API_KEY = 'AIzaSyBdlmiaOkL9aHvxt7cOEwK793Twr3S1v1w';
        const CLIENT_ID = '186346187188-6o1i90f7dngu475umv2o5s31jmrgo64h.apps.googleusercontent.com';

        const SCOPES = [
            'https://www.googleapis.com/auth/drive.file',
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/drive.activity'
        ];

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isAuthorized = false;

        const authButton = document.getElementById('authButton');
        const userName = document.getElementById('userName');
        const searchResultsDiv = document.getElementById('searchResults');
        const activityLogDiv = document.getElementById('activityLog');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        function showMessage(text) {
            messageText.innerText = text;
            messageBox.style.display = 'flex';
        }

        function hideMessage() {
            messageBox.style.display = 'none';
        }

        // Initialize the app after both libraries are loaded and the DOM is ready
        window.onload = function() {
            const checkAndInit = () => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined' && typeof google.accounts !== 'undefined') {
                    // Both libraries are loaded, proceed with initialization
                    gapi.load('client', () => {
                        gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest", "https://www.googleapis.com/discovery/v1/apis/driveactivity/v2/rest"]
                        }).then(() => {
                            gapiInited = true;
                            handleClientLoad();
                        }).catch(err => {
                            showMessage('Google API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
                        });
                    });

                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES.join(' '),
                        callback: (tokenResponse) => {
                            if (tokenResponse && tokenResponse.access_token) {
                                gapi.client.setToken(tokenResponse);
                                isAuthorized = true;
                                updateAuthStatus();
                                queryActivities();
                            }
                        },
                    });
                    gisInited = true;
                    handleClientLoad();

                } else {
                    // Libraries not yet loaded, try again in a bit
                    setTimeout(checkAndInit, 100);
                }
            };
            checkAndInit();
        };

        function handleClientLoad() {
            if (gapiInited && gisInited) {
                authButton.onclick = handleAuthClick;
                authButton.disabled = false;
            }
        }

        function handleAuthClick() {
            if (isAuthorized) {
                isAuthorized = false;
                gapi.client.setToken('');
                updateAuthStatus();
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function updateAuthStatus() {
            if (isAuthorized) {
                gapi.client.drive.about.get({ fields: 'user' }).then(response => {
                    userName.innerText = `ã‚ˆã†ã“ã, ${response.result.user.displayName}ã•ã‚“`;
                    authButton.innerText = 'ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ';
                    authButton.classList.remove('btn-primary');
                    authButton.classList.add('btn-secondary');
                }).catch(err => {
                    showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
                });
            } else {
                userName.innerText = '';
                authButton.innerText = 'Googleã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³';
                authButton.classList.remove('btn-secondary');
                authButton.classList.add('btn-primary');
                searchResultsDiv.innerHTML = '';
                activityLogDiv.innerHTML = '<p class="text-gray-500">ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ã¾ã™...</p>';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€ã®URLã‹ã‚‰IDã‚’æŠ½å‡ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function extractIdFromUrl(url) {
            if (!url) return null;
            // å…±é€šã®Google Drive URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            const fileMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (fileMatch) return fileMatch[1];

            const folderMatch = url.match(/\/drive\/folders\/([a-zA-Z0-9_-]+)/);
            if (folderMatch) return folderMatch[1];
            
            return null;
        }

        async function searchFilesAndFolders() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const query = document.getElementById('searchQuery').value;
            searchResultsDiv.innerHTML = '<p class="text-gray-500">æ¤œç´¢ä¸­...</p>';
            
            const params = {
                pageSize: 20,
                q: `name contains '${query}' and trashed = false`
            };
            
            try {
                const response = await gapi.client.drive.files.list(params);
                const files = response.result.files;
                if (files && files.length > 0) {
                    searchResultsDiv.innerHTML = '<h3 class="font-semibold mt-2">æ¤œç´¢çµæœ:</h3>';
                    files.forEach(file => {
                        const icon = file.mimeType === 'application/vnd.google-apps.folder' ? 'ğŸ“' : 'ğŸ“„';
                        const item = document.createElement('div');
                        item.classList.add('p-2', 'bg-gray-100', 'rounded-md');
                        item.innerHTML = `<p>${icon} <b>${file.name}</b></p><p class="text-xs text-gray-500">ID: ${file.id}</p>`;
                        searchResultsDiv.appendChild(item);
                    });
                } else {
                    searchResultsDiv.innerHTML = '<p class="text-gray-500">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
                }
            } catch (err) {
                showMessage('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function uploadFile() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files[0];
            const userProvidedName = document.getElementById('uploadFileName').value;
            let fileName = userProvidedName;

            if (!file) {
                showMessage('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // Check if the user has provided a file name.
            if (userProvidedName) {
                // If the user-provided name does NOT contain an extension
                if (!userProvidedName.includes('.')) {
                    // Get the original file's extension
                    const originalExtension = file.name.split('.').pop();
                    // Append the extension if it exists and is not the same as the full original name
                    if (originalExtension && originalExtension !== file.name) {
                        fileName += `.${originalExtension}`;
                    }
                }
            } else {
                // If the user did not provide a file name, use the original file name
                fileName = file.name;
            }

            const metadata = {
                name: fileName,
                mimeType: file.type
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                    body: form,
                });
                const result = await response.json();
                showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${result.name}ã€ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ID: ${result.id}`);
            } catch (err) {
                showMessage('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error(err);
            }
        }

        async function downloadFile() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileUrl = document.getElementById('downloadFileUrl').value;
            const fileId = extractIdFromUrl(fileUrl);
            
            if (!fileId) {
                showMessage('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                const fileMetadata = await gapi.client.drive.files.get({ fileId: fileId });
                const fileName = fileMetadata.result.name;

                const blob = new Blob([response.body], { type: response.headers['Content-Type'] });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
            } catch (err) {
                showMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function shareFile() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileUrl = document.getElementById('shareUrl').value;
            const fileId = extractIdFromUrl(fileUrl);
            const email = document.getElementById('shareEmail').value;

            if (!fileId || !email) {
                showMessage('æœ‰åŠ¹ãªURLã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const permission = {
                type: 'user',
                role: 'reader',
                emailAddress: email
            };

            try {
                await gapi.client.drive.permissions.create({
                    fileId: fileId,
                    resource: permission
                });
                showMessage(`ID: ${fileId}ã‚’${email}ã¨å…±æœ‰ã—ã¾ã—ãŸã€‚`);
            } catch (err) {
                showMessage('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function unshareFile() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileUrl = document.getElementById('unshareUrl').value;
            const fileId = extractIdFromUrl(fileUrl);
            
            if (!fileId) {
                showMessage('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                const permissionsResponse = await gapi.client.drive.permissions.list({ fileId: fileId });
                const permissions = permissionsResponse.result.permissions;
                let userPermissionId = null;
                const aboutResponse = await gapi.client.drive.about.get({ fields: 'user' });
                const myEmail = aboutResponse.result.user.emailAddress;

                for (const perm of permissions) {
                    if (perm.type === 'user' && perm.emailAddress === myEmail) {
                        userPermissionId = perm.id;
                        break;
                    }
                }

                if (!userPermissionId) {
                    showMessage('å…±æœ‰ã‚’åœæ­¢ã™ã‚‹æ¨©é™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    return;
                }

                await gapi.client.drive.permissions.delete({
                    fileId: fileId,
                    permissionId: userPermissionId
                });
                showMessage(`ID: ${fileId}ã®å…±æœ‰ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚`);

            } catch (err) {
                showMessage('å…±æœ‰åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function createFolder() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const folderName = document.getElementById('createFolderName').value;
            if (!folderName) {
                showMessage('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileMetadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };

            try {
                const response = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });
                showMessage(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ID: ${response.result.id}`);
                queryActivities(); // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆå¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å†èª­ã¿è¾¼ã¿
            } catch (err) {
                showMessage('ãƒ•ã‚©ãƒ«ãƒ€ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function deleteFileOrFolder() {
            if (!isAuthorized) {
                showMessage('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const fileUrl = document.getElementById('deleteUrl').value;
            const fileId = extractIdFromUrl(fileUrl);
            
            if (!fileId) {
                showMessage('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«/ãƒ•ã‚©ãƒ«ãƒ€URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            try {
                await gapi.client.drive.files.delete({ fileId: fileId });
                showMessage(`ID: ${fileId}ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                queryActivities(); // å‰Šé™¤å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å†èª­ã¿è¾¼ã¿
            } catch (err) {
                showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.result.error.message);
            }
        }

        async function queryActivities() {
            if (!isAuthorized) {
                activityLogDiv.innerHTML = '<p class="text-gray-500">ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ã¾ã™...</p>';
                return;
            }

            activityLogDiv.innerHTML = '<p class="text-gray-500">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            
            const params = {
                pageSize: 10,
                filter: `time > "${new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()}"` // éå»7æ—¥é–“
            };

            try {
                const response = await gapi.client.driveactivity.activities.query(params);
                const activities = response.result.activities;
                activityLogDiv.innerHTML = '';

                if (activities && activities.length > 0) {
                    activities.forEach(activity => {
                        const actorName = activity.actors[0].user?.knownUser?.personName || 'Unknown';
                        const actionType = Object.keys(activity.actions[0])[0];
                        const targetName = activity.targets[0].driveItem?.title || 'Unknown Item';
                        const timestamp = new Date(activity.timestampMicros / 1000).toLocaleString('ja-JP');

                        const logItem = document.createElement('div');
                        logItem.classList.add('p-2', 'bg-gray-100', 'rounded-md', 'text-sm');
                        logItem.innerHTML = `<p><b>${actorName}</b>ã•ã‚“ãŒ<b>${targetName}</b>ã‚’<b>${convertActionType(actionType)}</b>ã—ã¾ã—ãŸã€‚<br><span class="text-xs text-gray-500">${timestamp}</span></p>`;
                        activityLogDiv.appendChild(logItem);
                    });
                } else {
                    activityLogDiv.innerHTML = '<p class="text-gray-500">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ã€å‹•ä½œã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>';
                }
            } catch (err) {
                console.error('Failed to query activities:', err);
                showMessage('ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (err.result?.error?.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                activityLogDiv.innerHTML = '<p class="text-gray-500">ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>';
            }
        }

        function convertActionType(type) {
            switch (type) {
                case 'create': return 'ä½œæˆ';
                case 'edit': return 'ç·¨é›†';
                case 'delete': return 'å‰Šé™¤';
                case 'move': return 'ç§»å‹•';
                case 'rename': return 'åå‰å¤‰æ›´';
                case 'permissionChange': return 'å…±æœ‰è¨­å®šå¤‰æ›´';
                default: return 'æ“ä½œ';
            }
        }
    </script>
</body>
</html>
